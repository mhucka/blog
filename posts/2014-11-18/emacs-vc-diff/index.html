<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Adapting Emacs’s vc diff for word-oriented diffs | So much to learn, so little brain</title>
<meta name="generator" content="Jekyll v4.0.0">
<meta property="og:title" content="Adapting Emacs’s vc diff for word-oriented diffs">
<meta property="og:locale" content="en_US">
<meta name="description" content="Modifying vc-mode’s diff to work better when soft-wrapping">
<meta property="og:description" content="Modifying vc-mode’s diff to work better when soft-wrapping">
<link rel="canonical" href="https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/">
<meta property="og:url" content="https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/">
<meta property="og:site_name" content="So much to learn, so little brain">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2014-11-18T00:00:00-06:00">
<script type="application/ld+json">
{"description":"Modifying vc-mode’s diff to work better when soft-wrapping","@type":"BlogPosting","headline":"Adapting Emacs’s vc diff for word-oriented diffs","dateModified":"2014-11-18T00:00:00-06:00","datePublished":"2014-11-18T00:00:00-06:00","url":"https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/~mhucka/blog/assets/css/style.css">
<link type="application/atom+xml" rel="alternate" href="https://www.cds.caltech.edu/~mhucka/blog/feed.xml" title="So much to learn, so little brain">
<link rel="shortcut icon" type="image/x-icon" href="/~mhucka/blog/images/favicon.ico">
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Adapting Emacs’s vc diff for word-oriented diffs | So much to learn, so little brain</title>
<meta name="generator" content="Jekyll v4.0.0">
<meta property="og:title" content="Adapting Emacs’s vc diff for word-oriented diffs">
<meta property="og:locale" content="en_US">
<meta name="description" content="Modifying vc-mode’s diff to work better when soft-wrapping">
<meta property="og:description" content="Modifying vc-mode’s diff to work better when soft-wrapping">
<link rel="canonical" href="https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/">
<meta property="og:url" content="https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/">
<meta property="og:site_name" content="So much to learn, so little brain">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2014-11-18T00:00:00-06:00">
<script type="application/ld+json">
{"description":"Modifying vc-mode’s diff to work better when soft-wrapping","@type":"BlogPosting","headline":"Adapting Emacs’s vc diff for word-oriented diffs","dateModified":"2014-11-18T00:00:00-06:00","datePublished":"2014-11-18T00:00:00-06:00","url":"https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.cds.caltech.edu/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet">
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css">
<link type="application/atom+xml" rel="alternate" href="https://www.cds.caltech.edu/~mhucka/blog/feed.xml" title="So much to learn, so little brain">

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
<script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({         tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] }       });</script>
</head>
<body>
<header class="site-header">

  <div class="wrapper">
<a class="site-title" rel="author" href="/~mhucka/blog/">So much to learn, so little brain</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/~mhucka/blog/about.html">About</a><a class="page-link" href="/~mhucka/blog/search/">Search</a><a class="page-link" href="/~mhucka/blog/categories/">Tags</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Adapting Emacs's vc diff for word-oriented diffs</h1>
<p class="page-description">Modifying vc-mode's diff to work better when soft-wrapping</p>
<p class="post-meta post-meta-title"><time class="dt-published" datetime="2014-11-18T00:00:00-06:00" itemprop="datePublished">
        Nov 18, 2014
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      3 min read
    
</span></p>

    
      <p class="keywords">
      
        <a class="keywords-link" href="/~mhucka/blog/categories/#software">software</a>
         
      
        <a class="keywords-link" href="/~mhucka/blog/categories/#emacs">emacs</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>A few years back, I changed how I work with text files (including LaTeX files) in Emacs: instead of using hard newlines to format paragraphs into lines, I use soft wrapping, and do not insert hard newlines except to break paragraphs.  This change was driven by the fact that, except for software development work, most modern editing environments (and most of what my colleagues send) assume soft-wrapped paragraphs.  This was an annoying change at first, but I worked out how to set up soft wrapping in Emacs so that I no longer really notice the difference.  However, one problem that remained involved the use of version control systems such as git: most of those systems are line-oriented by nature and they show differences in a line-oriented way by default.  The resulting diffs are basically unreadable if the source text does not contain hard line breaks.</p>

<p>Here is how I set up git and Emacs’s standard <em>vc</em> version control package for word-oriented diffs.  I put the following code in my <code class="highlighter-rouge">.emacs</code> file.  First, make sure to load the <code class="highlighter-rouge">vc</code> Emacs package:</p>

<div class="language-emacs-lisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">require</span> <span class="ss">'vc</span><span class="p">)</span>
</code></pre></div></div>

<p>Next, set <code class="highlighter-rouge">vc-git-diff-switches</code> to the following value to tell git to use word-oriented diffs instead of line-oriented diffs:</p>

<div class="language-emacs-lisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">setq</span> <span class="nv">vc-git-diff-switches</span> <span class="s">"--word-diff"</span><span class="p">)</span>
</code></pre></div></div>

<p>If you do the above, you’ll get word oriented diffs from Emacs’ <code class="highlighter-rouge">vc-diff</code>, but IMHO the format is very difficult to read: it’s expressed as in-line text codes, with <code class="highlighter-rouge">{+ ...}</code> and <code class="highlighter-rouge">[- ... ]</code> markers inserted by git diff to indicate what has been added or removed between the two versions of a file.  These are hard for the human visual system to pick out quickly.  What you really want is to use color to distinguish changes.  I searched and found <a href="https://gist.github.com/syohex/1521407">someone else’s solution</a> to colorize the diff output, but I couldn’t get it to work well in my environment.  So, I rewrote it.  My version uses Emacs’s advising functionality to modify Emacs’ <code class="highlighter-rouge">vc-diff</code> function to edit the git diff output and colorize it using Emacs overlays.  The colors are set by the two variables <code class="highlighter-rouge">vc-diff-added-face</code> and <code class="highlighter-rouge">vc-diff-deleted-face</code>.  Here’s the code:</p>

<div class="language-emacs-lisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">make-face</span> <span class="ss">'vc-diff-added-face</span><span class="p">)</span>
<span class="p">(</span><span class="nv">make-face</span> <span class="ss">'vc-diff-deleted-face</span><span class="p">)</span>
<span class="p">(</span><span class="nv">set-face-background</span> <span class="ss">'vc-diff-added-face</span> <span class="s">"lawn green"</span><span class="p">)</span>
<span class="p">(</span><span class="nv">set-face-background</span> <span class="ss">'vc-diff-deleted-face</span> <span class="s">"RosyBrown1"</span><span class="p">)</span>

<span class="p">(</span><span class="nv">defadvice</span> <span class="nv">vc-diff</span> <span class="p">(</span><span class="nv">after</span> <span class="nv">vc-diff-advice</span> <span class="nb">last</span>
                          <span class="nv">activate</span> <span class="nb">compile</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">save-window-excursion</span>
    <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">"*vc-diff*"</span>
      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">inhibit-read-only</span> <span class="no">t</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nv">re-search-forward</span> <span class="s">"\({\(\)\|\[\(-\)\)"</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
          <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">front-start</span> <span class="p">(</span><span class="nv">match-beginning</span> <span class="mi">0</span><span class="p">))</span>
                 <span class="p">(</span><span class="nv">front-end</span>   <span class="p">(</span><span class="nv">match-end</span> <span class="mi">0</span><span class="p">))</span>
                 <span class="p">(</span><span class="nv">addition-p</span>  <span class="p">(</span><span class="nv">match-beginning</span> <span class="mi">2</span><span class="p">))</span>
                 <span class="nv">back-start</span>
                 <span class="nv">back-end</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">cond</span> <span class="p">(</span><span class="nv">addition-p</span>
                   <span class="p">(</span><span class="nv">re-search-forward</span> <span class="s">"}"</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
                   <span class="p">(</span><span class="k">setq</span> <span class="nv">back-start</span> <span class="p">(</span><span class="nv">match-beginning</span> <span class="mi">0</span><span class="p">))</span>
                   <span class="p">(</span><span class="k">setq</span> <span class="nv">back-end</span> <span class="p">(</span><span class="nv">match-end</span> <span class="mi">0</span><span class="p">)))</span>
                  <span class="p">(</span><span class="no">t</span>
                   <span class="p">(</span><span class="nv">re-search-forward</span> <span class="s">"\-\]"</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
                   <span class="p">(</span><span class="k">setq</span> <span class="nv">back-start</span> <span class="p">(</span><span class="nv">match-beginning</span> <span class="mi">0</span><span class="p">))</span>
                   <span class="p">(</span><span class="k">setq</span> <span class="nv">back-end</span> <span class="p">(</span><span class="nv">match-end</span> <span class="mi">0</span><span class="p">))))</span>
            <span class="p">(</span><span class="k">if</span> <span class="nv">addition-p</span>
                <span class="p">(</span><span class="nv">overlay-put</span> <span class="p">(</span><span class="nv">make-overlay</span> <span class="nv">front-end</span> <span class="nv">back-start</span><span class="p">)</span>
                             <span class="ss">'face</span> <span class="ss">'vc-diff-added-face</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">overlay-put</span> <span class="p">(</span><span class="nv">make-overlay</span> <span class="nv">front-end</span> <span class="nv">back-start</span><span class="p">)</span>
                           <span class="ss">'face</span> <span class="ss">'vc-diff-deleted-face</span><span class="p">))</span>
            <span class="c1">;; Make sure to delete back-to-front, because the text will shift.</span>
            <span class="p">(</span><span class="nv">delete-region</span> <span class="nv">back-start</span> <span class="nv">back-end</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">delete-region</span> <span class="nv">front-start</span> <span class="nv">front-end</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">goto-char</span> <span class="nv">front-end</span><span class="p">)))</span>
        <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">))</span> <span class="p">))))</span>
</code></pre></div></div>

<p>Here’s an example of what the output looks like in an Emacs buffer.  You can see the effect is to color deletions in red and additions in green.</p>

<p>This example uses code and not plain text, to demonstrate that the change does not make code diffs any worse. (And actually, I think the result is better for code diffs too.) The result is basically equivalent to what you would get with <code class="highlighter-rouge">git diff —color-words</code> in a terminal, but designed for Emacs.</p>

<p>By the way, I’m still using Aquamacs 2.x, which is based on Emacs 23, so while I <em>think</em> the code above should work in later versions of Emacs or Aquamacs, I have not tested it there.</p>

<p>If you find problems or improvements, please let me know!</p>

  </div>
<a class="u-url" href="/~mhucka/blog/posts/2014-11-18/emacs-vc-diff/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/~mhucka/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/~mhucka/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/~mhucka/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Content licensed CC-BY 4.0</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
